name: Build, Push and Deploy a Docker Image

on:
 push:
   branches: [main]

permissions:
  contents: read
  packages: write

jobs:
 build-push-deploy-image:
   runs-on: ubuntu-latest
   steps:
     - name: Checkout repository
       uses: actions/checkout@v4

     - name: Log in to the Container registry
       uses: docker/login-action@v3.3.0
       with:
         registry: ghcr.io
         username: ${{ github.actor }}
         password: ${{ secrets.GITHUB_TOKEN }}

     - name: Download Encore CLI script
       uses: sozo-design/curl@v1.0.2
       with:
         args: --output install.sh -L https://encore.dev/install.sh

     - name: Install Encore CLI
       run: bash install.sh

     - name: Build Docker image
       run: /home/runner/.encore/bin/encore build docker myapp

     - name: Tag Docker image
       run: docker tag myapp ghcr.io/${{ github.repository }}:latest

     - name: Push Docker image
       run: docker push ghcr.io/${{ github.repository }}:latest

#     - name: Build and push Docker image
#       id: push
#       uses: docker/build-push-action@v6.5.0
#       with:
#         context: .
#         push: true
#         tags: ghcr.io/${{ github.repository }}:latest

#     - name: Deploy the app
#       uses: digitalocean/app_action/deploy@v2
#       env:
#         SAMPLE_DIGEST: ${{ steps.push.outputs.digest }}
#       with:
#         token: ${{ secrets.YOUR_DIGITALOCEAN_ACCESS_TOKEN_VARIABLE_NAME }}
